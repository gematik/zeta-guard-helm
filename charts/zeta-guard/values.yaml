global:
  image_pull_secret: nil
  registry: europe-west3-docker.pkg.dev/gematik-pt-zeta-prod/zeta-dcr/
  registry_host: "europe-west3-docker.pkg.dev/gematik-pt-zeta-prod/zeta-dcr/"

registry_name: ""

authserver:
  image:
    repository: keycloak-zeta
    tag: 0.3.2
    pullPolicy: Always
  # Provider configuration for ZETA SMC-B token-exchange implementation
  provider:
    smcB:
      opa:
        enabled: true
      opaBaseUrl: "http://opa:8181"
      decisionPath: "/v1/data/zeta/authz/decision"
      connectionTimeoutMs: 1000
      readTimeoutMs: 2000
      failClosed: true
  admin:
    username: admin
    # HINT: THIS IS TEMPORARY! CHANGE AT RUNTIME!
    # TODO: use robust Secret-based strategy
    password:
  config:
    maxClients: "256"
    clientRegistrationTTL: "PT5M"
    clientRegistrationSchedulerInterval: "PT2M"
  resources: { }
  # mostly for test setup purposes
  # Adds an entry to the authserver's hosts file, mapping hostAlias.ip to hostAlias.name
  hostAlias: { }
  log:
    level: "INFO"

# authServerLogConsoleOutput sets the log output to JSON or default (plain) unstructured logging
authServerLogConsoleOutput: json

# authServerMetricsEnabled enables the metrics endpoint for Keycloak
authServerMetricsEnabled: true

# authServerTracingEnabled enables the OpenTelemetry tracing
authServerTracingEnabled: true

pepproxy:
  image:
    repository: ngx_pep
    tag: 0.3.0
    pullPolicy: Always
  wellKnownBase: http://localhost
  # boolean that controls if ASL should be enabled (true) or not (false)
  asl_enabled: true
  nginxConf:
    configMapName: pep-nginx-conf
    generateConfigMap: false

    httpClientAcceptInvalidCerts: false

    # enables ASL test mode. This will practically disable encryption! NEVER USE IN PRODUCTION!
    aslTestmode: false

    # fachdienstUrl defines the fachdienst url to be used for the pep-proxy.
    fachdienstUrl: ""

    # JWKS issuer for PoPP key validation.
    poppIssuer: ""

    # OIDC issuer (iss) of the authorization server (e.g., zeta-guard-realm).
    pepIssuer: ""

    # requiredAudience defines the audience required for a valid access token.
    requiredAudience: ""

    # requiredScopes defines scopes required for a valid access token.
    requiredScopes: [ ]

# pepproxyMetricsEnabled enables the metrics endpoint for Keycloak
pepproxyMetricsEnabled: true

# pepproxyTracingEnabled enables tracing for nginx
pepproxyTracingEnabled: true

# When true, the ingress routes traffic to the tiger-proxy service
# instead of directly exposing internal services.
routeViaTigerProxy: false

# When enabled, injects a changing annotation to force pod rollouts
# on each helm upgrade/apply even if image tag is unchanged.
devMode: false


# DB mode switch:
# - bitnami: using Bitnami subchart service/secret only for demo purposes – no support at all
# - operator: using Zalando Postgres Operator
# - external: use external db by providing filling values authserverDb.kcDb, authserverDb.kcDbUrl,
#       authserverDb.kcDbSchema, authserverDb.kcDbUsername, authserverDb.kcDbPasswordSecretName
#       The db password is pulled from the "password" field of a secret going by the provided name. The other properties
#       behave according to the keycloak environment variables. See https://www.keycloak.org/server/db
databaseMode: operator
postgresql:
  enabled: false

# Which cert-manager ClusterIssuer to use for TLS on the Ingress (default)
clusterIssuer: ""

# IngressClass used by the generated Ingress.
# - With the bundled NIC: keep equal to nginx-ingress.controller.ingressClass.name.
# - With an external controller: disable the bundled NIC and set this to your class (e.g., gce, openshift-default).
ingressClassName: "nginx"

# Ingress configuration extensions
ingress:
  annotations: {}

nginx-ingress:
  enabled: true
  controller:
    # We use standard Kubernetes Ingress; disable NIC CRDs to avoid CRD install requirement
    enableCustomResources: false
    ingressClass:
      name: nginx
    service:
      # Default for standalone/cloud installs.
      type: LoadBalancer
      externalTrafficPolicy: Cluster
    config:
      entries:
        # AFOs: GS-A_5035, GS-A_4387, A_18464, GS-A_4385, A_18467
        ssl-protocols: "TLSv1.2 TLSv1.3"
        # AFOs: A_17322, A_21275-01, A_17124-03, GS-A_5016; (GS-A_4384-03 omitted)
        ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384"
        # AFOs: GS-A_4359-02, GS-A_4357-02
        ssl-ecdh-curve: "prime256v1:secp384r1:brainpoolP256r1:brainpoolP384r1"
        # AFOs: GS-A_5322 - disable server side cache, use client tickets only
        ssl-session-cache: "none"
        # ssl_session_ticket_key (not specified, default) - use random generated keys with hourly rotation
        ssl-session-tickets: "on"
        ssl-session-timeout: "5m"
        # ssl_stapling off (default) - A_26964 omitted, since LetsEncrypt does not provide OCSP anymore
        ssl-stapling: "off"
        # AFOs: A_17775 - use client order
        ssl-prefer-server-ciphers: "false"
        # AFOs: GS-A_5526 - renegotiation disabled by default since v0.8.23
opa:
  enabled: true
  replicaCount: 1
  serviceAccountName: ""
  image:
    # use the default registry here
    registry: "openpolicyagent"
    repository: /opa
    tag: 1.11.0-static
    pullPolicy: IfNotPresent
  # Set OPA server log level: debug|info|warn|error (default: info)
  logLevel: info
  # Bundle mode (disabled by default) — inline policyRego is used when disabled
  bundle:
    enabled: false
    # Logical service name used in OPA config (e.g., 'gitlab-registry' or 'local-proxy')
    serviceName: registry
    # Base URL of registry
    url: ""
    # fully qualified resource (including the registry host)
    resource: ""
    credentials:
      # Reference a Secret containing registry bearer credentials.
      secretRef:
        # Name of the Secret in the release namespace that holds credentials
        name: ""
    polling:
      min_delay_seconds: 120
      max_delay_seconds: 180
    # Signature verification for OPA bundles
    verification:
      enabled: true
      # set in env-specific values
      keyId: ""
      algorithm: ""
      publicKey: ""
  # Workload Identity Federation (AKS → GCP STS) for GAR access
  workloadIdentityFederation:
    enabled: false
    sts:
      # GPC service-account (email format)
      sa: ""

    tokenRenewer:
      enabled: true
      # Default schedule: refresh every 45 minutes
      # Immediately get token: kubectl -n NAMESPACE create job token-renewer-once --from=cronjob/opa-token-renewer-cronjob
      schedule: "*/45 * * * *"
      # Number of retries for failed Jobs spawned by the CronJob
      backoffLimit: 5

  # --- Example: Workload Identity Federation (WIF) ---
  #
  # WIF mode (AKS → GCP STS → GAR)
  # serviceAccountName: opa
  # bundle:
  #   enabled: true
  #   serviceName: gar
  #   url: https://<region>-docker.pkg.dev
  #   resource: <PROJECT_ID>/<REPO>/<IMAGE>:<TAG>
  #   credentials:
  #     secretRef:
  #       name: ""   # keep empty in WIF mode
  #    verification:
  #      enabled: true
  #      keyId: zeta_artifact_reg
  #      algorithm: ES256
  #      publicKey: |
  #        -----BEGIN PUBLIC KEY-----
  #        ...
  #        -----END PUBLIC KEY-----
  # workloadIdentityFederation:
  #   enabled: true
  #   sts:
  #     # Use the provider resource name, for example:
  #     # //iam.googleapis.com/projects/<PROJECT_ID>/locations/global/workloadIdentityPools/<pool>/providers/<provider>
  #     audience: ""
  #     iamUrl: "https://iamcredentials.googleapis.com"
  #     sa: ""
  #     scope: "https://www.googleapis.com/auth/cloud-platform"
  #     tokenUrl: "https://sts.googleapis.com/v1/token"
  #   tokenRenewer:
  #     schedule: "*/45 * * * *"
  #
  # --- Examples: GitLab/Basic mode (deploy-token) ---
  # bundle:
  #   enabled: true
  #   serviceName: gitlab
  #   url: https://registry.example.com:443
  #   resource: registry.example.com/group/project/policy-bundle:latest
  #   credentials:
  #     secretRef:
  #       name: opa-bearer   # Secret with token='USERNAME:PASSWORD', scheme='Basic'
  health:
    liveness:
      periodSeconds: 20
    readiness:
      periodSeconds: 20
  resources: {}

# opaDistributedTracingEnabled enables distributed tracing with a gRPC endpoint
opaDistributedTracingEnabled: true

# If opaStatusPrometheus is true, export the status (bundle and plugin) metrics to prometheus
opaStatusPrometheus: true

# OPA policy/data configuration for Keycloak→OPA showcase
opaPolicy:
  # Enable console decision logs in OPA
  logDecisions: true
  # Default fake policy: allow-all decision object.
  # The policies will be loaded from PIP and PAP Service (workload identity federation or secretRef)
  policyRego: |
    package zeta.authz

    # Minimal decision object compatible with callers expecting
    # data.zeta.authz.decision => {"allow": bool, "ttl": {"access_token": number, "refresh_token": number}}
    decision := {
      "allow": true,
      "ttl": {
        "access_token": 300,
        "refresh_token": 86400,
      },
    }

# If logCollectorEnabled is true, pods, services, and other resources for the log collector are added to the helm release
logCollectorEnabled: true

log-collector:
  mode: daemonset
  image:
    repository: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-k8s
  command:
    name: otelcol-k8s
  presets:
    logsCollection:
      enabled: true
    kubernetesAttributes:
      enabled: true
  config:
    exporters:
      otlp/telemetry-gateway:
        # ToDo prefix with release name
        endpoint: telemetry-gateway:4317
        tls:
          insecure: true

    receivers:
      filelog:
        exclude:
          - /var/log/pods/*log-collector*/log-collector/*.log
          - /var/log/pods/*telemetry-gateway*/telemetry-gateway/*.log

    service:
      pipelines:
        logs:
          receivers: [ filelog ]
          exporters:
            - otlp/telemetry-gateway
        metrics:
          receivers: [ prometheus ]
          exporters:
            - otlp/telemetry-gateway
        traces: null

  ports:
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false

  additionalLabels:
    app.kubernetes.io/part-of: zeta-guards

# telemetryGatewayEnabled adds the telemetry gateway to the helm release
telemetryGatewayEnabled: true

telemetry-gateway:
  mode: deployment
  image:
    repository: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-k8s
  command:
    name: otelcol-k8s
  presets:
    kubernetesAttributes:
      enabled: true
      extractAllPodLabels: true
      extractAllPodAnnotations: true
  config:
    processors:
      redaction/betreiber:
        # by default, keep all attributes
        allow_all_keys: true
        # remove attributes with keys matching these patterns
        blocked_key_patterns:
          - ".*token.*"
        # redact these patterns inside attribute values
        blocked_values:
          ### A_25744 - ZETA Guard - Datenschutzkonformes Logging und Monitoring
          # taken from https://github.com/stefanboeck/privacylight/blob/main/privacylight/detection.py
          # email addresses
          - '[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}'
          # IBAN
          - '[A-Z]{2}\d{2}[A-Z0-9]{10,30}'
          # credit card numbers
          - '\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}'
          # German phone numbers
          - '(?:\+49|0049|0)[\s-]?1[5-7]\d[\s-]?\d{7,8}'

          ### A_25745 - ZETA Guard - Keine medizinischen Informationen in Logging und Monitoring

          ### A_25746 - ZETA Guard - Keine sicherheitsrelevanten Daten in Logging und Monitoring
          # JWT
#          - '([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_=]+)\.([a-zA-Z0-9_\-\+\/=]*)'
          # The following patterns are taken from https://help.nightfall.ai/detection_platform/regex_library
          # ECDSA Private Key
          - '^-----BEGIN ECDSA PRIVATE KEY-----\s.*,ENCRYPTED(?:.|\s)+?-----END ECDSA PRIVATE KEY-----$'
          # SSL Certificate
          - '^-----BEGIN CERTIFICATE-----(?:.|\n)+?\s-----END CERTIFICATE-----$'

          ### mixed bag of patterns
          - '^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,7}$'
          - '^([0-9a-zA-Z\-=_]{20,})\.([0-9a-zA-Z\-_=]{3,})\.([0-9a-zA-Z\-_=]*)$'
          - 'eyJ[A-Za-z0-9-_=]+?\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*'
          - >
            client_(id|secret)['"\s:=]+[a-zA-Z0-9\-_.~]{10,100}
          - 'AKIA[0-9A-Z]{16}'
          - >
            aws(.{0,20})?(?-i)['"]?[0-9A-Za-z\/+]{40}['"]?
          - 'AIza[0-9A-Za-z\-_]{35}'
          - 'ghp_[0-9a-zA-Z]{36}'
          - 'glpat-[0-9a-zA-Z-_]{20}'
          - 'xox[baprs]-([0-9a-zA-Z]{10,48})?'
          - 'sk_live_[0-9a-zA-Z]{24}'
          - 'pk_live_[0-9a-zA-Z]{24}'
          - 'SK[0-9a-fA-F]{32}'
          - 'SG\.[\w\d\-_]{22}\.[\w\d\-_]{43}'
          - 'sl\.[A-Za-z0-9_-]{20,100}'
          - 'shpat_[0-9a-fA-F]{32}'
          - 'EAACEdEose0cBA[0-9A-Za-z]+'
          - >
            [ hH ]eroku['"][0-9a-f]{32}['"]
          - 'dop_v1_[a-z0-9]{64}'
          - '0/[0-9a-z]{32}'
          - 'lin_api_[a-zA-Z0-9]{40}'
          - '\d{9}:[a-zA-Z0-9_-]{35}'
          - >
            mongodb(\+srv)?:\/\/[^\s'"/]+
          - >
            postgres(?:ql)?:\/\/[^\s'"/]+
          - >
            mysql:\/\/[^\s'"/]+
          - >
            redis:\/\/[^\s'"/]+
          - >
            elasticsearch:\/\/[^\s'"/]+
          - >
            jdbc:\w+:\/\/[^\s'"/]+
          - '[A-Za-z]:\\(?:[^\\\n\r]+\\)*[^\\\n\r\.]+\.[\w]+'
          - >
            (username|user|email)['"\s:=]+[^\s'"@]{1,100}['"].*?(password|pwd)['"\s:=]+[^\s'" ]{4,100}
          - '\b\d{1,5}\s*(?:[A-Za-zÀ-ÿ0-9.-]+\s+)*(?:Straße|Str\.|Strasse|Street|St\.|Road|Rd\.|Avenue|Ave\.|Boulevard|Blvd\.|Lane|Ln\.|Weg|Alle[e]?|Gasse|Place|Pl\.|Drive|Dr\.|Court|Ct\.|Square|Sq\.|Parkway|Pkwy\.)\b'
        # don't change attributes with keys matching these patterns
        ignored_key_patterns:
          - '^app\.kubernetes\.io\/.+'
          - '^container\..+'
          - '^k8s\..+'
          - '^net\..+'
          - '^log\..+'
          - '^otel\..+'
          - '^service\..+'
        ignored_keys:
          - http.user_agent
        redact_all_types: true
        summary: info

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
          http:
            endpoint: ${env:MY_POD_IP}:4318
      prometheus:
        config:
          scrape_configs:
            - job_name: authserver
              metrics_path: /auth-mgmt/metrics  # align with KC_HTTP_MANAGEMENT_RELATIVE_PATH
              scrape_interval: 5s
              static_configs:
                # align with KC_HTTP_MANAGEMENT_PORT
                - targets: [ authserver:9000 ]

            - job_name: opa
              scrape_interval: 5s
              static_configs:
                - targets: [ opa:8181 ]

            - job_name: policy-execution-point
              scrape_interval: 5s
              static_configs:
                - targets: [ pep-proxy-svc:9113 ]

            - job_name: telemetry-gateway
              scrape_interval: 5s
              static_configs:
                - targets: [ "${env:MY_POD_IP}:8888" ]

    service:
      pipelines:
        logs:
          receivers: [ otlp ]
          exporters: [ debug ]
        metrics:
          receivers:
            - otlp
            - prometheus
          exporters: [ debug ]
        traces:
          receivers: [ otlp ]
          exporters: [ debug ]

  ports:
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
  additionalLabels:
    app.kubernetes.io/part-of: zeta-guards

gematikConnectionEnabled: false   # will be enabled by default in a future release
